rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isUserSelfExcluded(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.selfExclusion.isActive == true;
    }

    match /users/{userId} {
      allow read: if request.auth.uid == userId || request.auth.token.admin == true;
      
      allow update: if request.auth.uid == userId &&
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly([
                         'displayName', 'username', 'photoURL', 
                         'responsibleGamingLimits', 'selfExclusion'
                       ]);
                       
      allow create: if false;

      allow write: if request.auth.token.admin == true;

      // Allow reads on user subcollections (e.g., notifications)
      match /{subcollection}/{docId} {
        allow read, write: if request.auth.uid == userId;
      }
    }

    match /games/{gameId} {
      // Allow any authenticated user to read game documents.
      allow read: if request.auth != null;

      // Odds are stored in a subcollection.
      match /bookmaker_odds/{bookmakerId} {
        // Allow any authenticated user to read odds.
        allow read: if request.auth != null;
        // Writes should be handled by a secure backend process.
        allow write: if false;
      }
    }

    match /bets/{betId} {
      allow read: if resource.data.isPublic == true ||
                     request.auth.uid == resource.data.creatorId || 
                     request.auth.uid == resource.data.takerId ||
                     request.auth.token.admin == true;

      allow create: if request.auth != null && 
                       isUserSelfExcluded(request.auth.uid) == false &&
                       request.resource.data.creatorId == request.auth.uid;

      allow update: if request.auth != null && isUserSelfExcluded(request.auth.uid) == false && (
                      (resource.data.status == 'pending' && request.resource.data.status == 'accepted' && request.resource.data.takerId == request.auth.uid) ||
                      (resource.data.status == 'accepted' && request.resource.data.status == 'disputed')
                    ) ||
                    request.auth.token.admin == true;

      allow delete: if false;
    }

    match /transactions/{transactionId} {
      allow read: if request.auth.uid == resource.data.userId || request.auth.token.admin == true;
      allow write: if false;
    }

    match /disputes/{disputeId} {
        allow read: if request.auth.uid == resource.data.disputingUserId ||
                       get(/databases/$(database)/documents/bets/$(resource.data.betId)).data.creatorId == request.auth.uid ||
                       get(/databases/$(database)/documents/bets/$(resource.data.betId)).data.takerId == request.auth.uid ||
                       request.auth.token.admin == true;

        allow create: if request.auth != null && request.resource.data.disputingUserId == request.auth.uid &&
                         (get(/databases/$(database)/documents/bets/$(request.resource.data.betId)).data.creatorId == request.auth.uid ||
                          get(/databases/$(database)/documents/bets/$(request.resource.data.betId)).data.takerId == request.auth.uid);

        allow update: if false;
        allow delete: if false;
    }
  }
}